// STM32F030 (STM32F103) + AD9850
// ?????: vk.com/zz555 (23.07.2015)
// ????????? SPI Master ? STM32 - http://easystm32.ru/interfaces/45-spi-interface-part-2
// DDS generator ad9850 - http://radiokot.ru/forum/viewtopic.php?p=1688775
// ??????????? ??????????? - http://www.zapisnyh.narod.ru/virt.htm

// PA0  - LED
// PC13 - LED (stm32f103)

// PA4 - NSS
// PA5 - SPI1_SCK
// PA6 - SPI1_MISO (Master In)
// PA7 - SPI1_MOSI (Master Out)

#include "main.h"

uint8_t    i;
uint8_t    data;
uint8_t    SPIData;
uint8_t    led_st;
uint32_t    TimingDelay;
uint32_t    freq;               // dds ??????? Hz

union un_dataword 
{               // 5 ????, ???????????  ???????? ?????? ??? ???????? AD9850
	uint32_t    dataword_freq;           // 32 ??? ?????,  ??? ?????????? ????????
	uint8_t    dataword_byte[5];      // ?????? ??? ?????????? ???????
}un;

// ?????????? ?????????? ?? SPI1 (for spi slave)
void SPI1_IRQHandler(void) 
{
	SPIData=0;
	if ((SPI1->SR & SPI_SR_RXNE) == 1) 
	{                        // ?????????? ??????? ??????? ??????
		SPIData = SPI1->DR;                                  // ?????? ?? ??? ??????, clear flag
		if (led_st == 1) 
		{
			LED_0; 
			led_st=0;
		} 
		else 
		{
			LED_1; 
			led_st=1;
		}    // ??????????? ????????? ??????????
		SPI1->DR = SPIData;                                  // ?????????? ??????? ?? ??? ???????
	}
}

// ?????????? ?????????¤ ?????????? ???????, ?????????¤ ?????? 1 ms
void SysTick_Handler() {
	if (TimingDelay != 0) TimingDelay--;
}

// ??????? ????????? ???????? ? ????????????
void Delay_ms(uint32_t nTime) {
	TimingDelay = nTime;
	while (TimingDelay != 0) {}
}

void Delay_us() {
	uint8_t i;
	for (i=0; i<1; i++) {i++; i--;}
}

void SPISendByte(uint8_t data) 
{
	//CS_ON();                                     // ?????? ?????? CS ??????
	// while (!(SPI1->SR & SPI_SR_TXE));                     // ?????????, ??? ?????????? ???????? ????????? (STM32F103)
	//SPI1_DR_8bit=data;                              // (STM32F103) ????? ?? ?????????
	SPI1->DR=data;                                 // (STM32F103) ????? ?? ?????????
	//   while (!(SPI1->SR & SPI_SR_RXNE));                    // ???? ????????? ?????? (STM32F103)
	while (SPI1->SR & SPI_SR_BSY);                     // ???? ????? ???????? (STM32F030)
	if ((SPI1->SR & SPI_SR_RXNE) == 1) SPIData=SPI1->DR;    // ???? ?????? ??????, ?????? ???????? ?????? (STM32F030)
	//CS_OFF();                                     // ??????? ?????? CS
}

void SetFrequency(uint32_t frequency) 
{
	uint8_t i;

	un.dataword_freq = (frequency*4294967296)/125000000;
	un.dataword_byte[4] = 0;

	CS_OFF();                  // FQ_UD 1
	Delay_us();
	CS_ON();                  // FQ_UD 0
	Delay_us();

	for (i=0; i<5; i++) SPISendByte(un.dataword_byte[i]);

	CS_OFF();                  // FQ_UD 1
	Delay_us();
	CS_ON();                  // FQ_UD 0
	Delay_us();
}

// ?????????????  SPI1 for STM32F030
void stm_init() {
   SystemInit();
   SysTick_Config(48000);         // ?????? ?????????? ?? ????????? ???????? ??? ??????? 48 MHz - 1ms

   RCC->AHBENR |= RCC_AHBENR_GPIOAEN;
   RCC->APB2ENR |= RCC_APB2ENR_SPI1EN;

   // PA4 - SPI_NSS
   // PA5 - SPI1_SCK
   // PA6 - SPI1_MISO (Master In)
   // PA7 - SPI1_MOSI (Master Out)

   GPIOA->MODE      |= (GPIO_MODER_MODER0_0 | GPIO_MODER_MODER4_0 | GPIO_MODER_MODER5_1 | GPIO_MODER_MODER6_1 | GPIO_MODE7_1);
   // MODER 32 ?????????
   // 00 - ?? ????????? ????
   // 01 (GPIO_MODER_MODER0_0) - ?????
   // 10 (GPIO_MODER_MODER0_1) - ?????????????? ???????
   // 11 (GPIO_MODER_MODER0) - ?????????? ?????

   GPIOA->PUPDR   |= (GPIO_PUPDR_PUPDR0_0 | GPIO_PUPDR_PUPDR4_0 | GPIO_PUPDR_PUPDR5_0 | GPIO_PUPDR_PUPDR6_0 | GPIO_PUPDR_PUPDR7_0);   // ???????? ? "+"
   // OPUPDR 32 ?????????
   // 00 - ??? ????????(?? ?????????)
   // 01 (GPIO_PUPDR_PUPDR0_0) - ???????? ? "+"
   // 10 (GPIO_PUPDR_PUPDR0_1) - ???????? ? "-"

   GPIOA->OSPEED   |= (GPIO_OSPEEDER_OSPEEDR4 | GPIO_OSPEEDER_OSPEEDR5 | GPIO_OSPEEDER_OSPEEDR6 | GPIO_OSPEEDER_OSPEEDR7);   // 50???
   // OSPIDER 32 ?????????
   // x0 (GPIO_OSPEEDER_OSPEEDR0_1) - 2???
   // 01 (GPIO_OSPEEDER_OSPEEDR0_0) - 10???
   // 11 (GPIO_OSPEEDER_OSPEEDR0) - 50???

   GPIOA->AFR[0] = (GPIOA->AFR[0] & ~(GPIO_AFRL_AFRL5 | GPIO_AFRL_AFRL6 | GPIO_AFRL_AFRL7)); // AF0 for SPI1 signals

   // ????????? SPI1
//   SPI1->CR2 = 0x0000;            // (STM32F103)
   SPI1->CR2 = (SPI_CR2_FRXTH | SPI_CR2_DS_0 | SPI_CR2_DS_1 | SPI_CR2_DS_2);      // (STM32F030) 8 ??? ?????? (0x1700)
//   SPI1->CR2 |= SPI_CR2_SSOE;       // (for slave) NSS - ???????????? ??? ????? ?????????? slave select (0x0004)
//   SPI1->CR2 |= SPI_CR2_RXNEIE;   // (for slave) ???????? ?????????? ?? ?????? ????? (0x0040)

//   SPI1->CR1 = 0x0000;            // Slave (0x0000)
   SPI1->CR1 = SPI_CR1_MSTR;      // 1 - ??????, 0 - Slave (0x0004)
   SPI1->CR1 |= SPI_CR1_BR;      // ????????? ???????? SPI Baud rate = Fpclk/256   (0x0038) (2,4,8,16,32,64,128,256)
//   SPI1->CR1 |= SPI_CR1_BR_2;      // ???????? SPI Baud rate = Fpclk/32 (0x0020)
   SPI1->CR1 |= SPI_CR1_SSM;      // ??????????? ????? NSS (0x0200) (0 - for slave)
   SPI1->CR1 |= SPI_CR1_SSI;      // NSS ??????? ???????, ????? ?????? ????? ??????? (0x0100)
   SPI1->CR1 |= SPI_CR1_SPE;      // ????????? ?????? ?????? SPI (0x0040)
//   SPI1->CR1 &= ~SPI_CR1_CPOL;    // ?????????? ????????? ??????? (CK to 0 when idle) (0x0002)
//   SPI1->CR1 &= ~SPI_CR1_CPHA;    // ???? ????????? ??????? (|= SPI_CR1_CPHA - ?? ??????? ??????) (0x0001)
//   SPI1->CR1 |= SPI_CR1_DFF;       // (STM32F103) 16 ??? ?????? (0x0800)
   SPI1->CR1 |= SPI_CR1_LSBFIRST;   // 1 - ??????? ?????????? ??????? ???, 0 - ??????? ?????????? ??????? ??? (0x0080) for dds

//   NVIC_EnableIRQ(SPI1_IRQn);       // Enable SPI1_IRQn
}

int main(void) {
   stm_init();

   LED_1;                              // stm32f030
   Delay_ms(100);
   LED_0;
   Delay_ms(300);
   LED_1;
   Delay_ms(100);
   LED_0;

//   while(1) {}                         // ??? ???????? ?? ??????????? (for spi slave)

   data=0;
   freq=0;                              // dds

   while(1) {                           // for dds
      freq=freq+100;
      SetFrequency(freq);
      LED_1;                           // stm32f030
      Delay_ms(10);
      LED_0;
      Delay_ms(90);
      if (freq==20000) {
         freq=0;
         SetFrequency(freq);
         Delay_ms(2000);
      }
   }

   /*
   while (1) {                           // for spi slace
      CS_ON();                         // ?????? ?????? CS ??????
      SPISendByte(data);                   // ???????? ???? ????? SPI1
      CS_OFF();                         // ??????? ?????? CS
       if ((data-1) == SPIData) LED_1;         // ?????? ?????????? ???????
                                                           // ???????? ??? ???? ??????????? ??????. ?????????? data, ? ??????? (data-1).
                                                             // ??? ???????  ? ???, ??? ????? ?? ????? ?????????? ?????? ???? ?????? ??
                                                             // ?????????? ????? ???????. ????? ??????? ???? ?????? ?????? ????????
                                                             // ????? 123, ?? ??? ??? ???????? ????? ?? ????? ?????????? ????????? ???? (124).
       data++;
       Delay_ms(10);
       LED_0;
       Delay_ms(200);
   }
   */
}